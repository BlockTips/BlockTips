<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BlockTips Donation</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <style>
    body { background: linear-gradient(135deg, #f0f4f8, #d9e2ec); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .card { border-radius: 15px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); transition: transform 0.3s ease; }
    .card:hover { transform: translateY(-5px); }
    .btn-primary { background: linear-gradient(90deg, #007bff, #0056b3); border: none; border-radius: 50px; padding: 12px 24px; }
    .btn-success { background: linear-gradient(90deg, #28a745, #1e7e34); border: none; border-radius: 50px; padding: 12px 24px; }
    #status { color: #28a745; font-weight: bold; animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .form-control { border-radius: 10px; border: 1px solid #ced4da; transition: border-color 0.3s; }
    .form-control:focus { border-color: #007bff; box-shadow: 0 0 0 0.25rem rgba(0,123,255,0.25); }
    .dark-mode { background: linear-gradient(135deg, #2c3e50, #1c2833); color: white; }
    .dark-mode .card { background: #34495e; box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
    .dark-mode .form-control { background: #495057; border-color: #6c757d; color: white; } /* White text for inputs */
    .dark-mode .form-select { background: #495057; border-color: #6c757d; color: white; } /* White text for select */
    .dark-mode #status { color: #2ecc71; }
    .dark-mode .text-center, .dark-mode h1, .dark-mode label, .dark-mode .form-label { color: white; } /* White for all text blocks */
    .btn-secondary { background: linear-gradient(90deg, #6c757d, #495057); } /* Better visibility for toggle button in dark mode */
    /* Mobile responsive */
    @media (max-width: 600px) {
      body { padding: 15px; }
      .card { border-radius: 10px; }
    }
  </style>
</head>
<body class="dark-mode">
  <div class="container my-4">
    <div class="text-end mb-2">
      <button class="btn btn-secondary btn-sm" onclick="toggleDarkMode()">Toggle Dark Mode</button>
    </div>
    <div class="card p-4">
      <h1 class="text-center mb-4">Donate to Creator via BlockTips</h1>
      <select id="networkSelect" class="form-select mb-3">
        <option value="testnet">Testnet (Cronos Testnet)</option>
        <option value="mainnet">Mainnet (Cronos Mainnet)</option>
      </select>
      <button id="connectButton" class="btn btn-primary w-100 mb-3">Connect Wallet</button>
      <form id="donationForm" style="display: none;">
        <div class="mb-3">
          <label for="amount" class="form-label">Amount in $ (e.g., 10):</label>
          <input type="number" id="amount" class="form-control" min="1" required>
        </div>
        <div class="mb-3">
          <label for="name" class="form-label">Your Name (or leave blank for anonymous):</label>
          <input type="text" id="name" class="form-control">
        </div>
        <div class="mb-3">
          <label for="message" class="form-label">Message:</label>
          <textarea id="message" class="form-control" rows="3"></textarea>
        </div>
        <button type="button" id="donateButton" class="btn btn-success w-100">Donate</button>
      </form>
      <div id="status" class="mt-3 text-center"></div>
    </div>
  </div>

  <script src="https://unpkg.com/ethers@6.11.1/dist/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/socket.io-client@4.5.1/dist/socket.io.min.js"></script>
  <script>
    const ethers = window.ethers;

    const creatorAddress = '0xC2e4F3103393dA92f3BbF83A6155E7D764E52321'; // Use same address for both, or update if mainnet-specific

    let networkConfig = {
      testnet: {
        chainId: '0x152', // Testnet (338 hex)
        rpcUrl: 'https://evm-t3.cronos.org',
        explorerUrl: 'https://explorer.cronos.org/testnet'
      },
      mainnet: {
        chainId: '0x19', // Mainnet (25 hex)
        rpcUrl: 'https://evm.cronos.org',
        explorerUrl: 'https://explorer.cronos.org'
      }
    };

    let selectedNetwork = 'testnet'; // Default to testnet

    let provider, signer;

    // Network select change
    document.getElementById('networkSelect').addEventListener('change', (e) => {
      selectedNetwork = e.target.value;
      if (signer) {
        switchNetwork(); // Switch if already connected
      }
    });

    async function switchNetwork() {
      try {
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: networkConfig[selectedNetwork].chainId }],
        });
        document.getElementById('status').textContent = `Switched to ${selectedNetwork.charAt(0).toUpperCase() + selectedNetwork.slice(1)}!`;
      } catch (error) {
        console.error('Switch network error:', error);
        document.getElementById('status').textContent = `Error switching network: ${error.message}`;
      }
    }

    // Connect button
    document.getElementById('connectButton').addEventListener('click', async () => {
      try {
        if (!window.ethereum) {
          throw new Error('No wallet extension detected. Install Crypto.com Onchain Wallet or similar.');
        }
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        await switchNetwork(); // Switch to selected network
        document.getElementById('connectButton').style.display = 'none';
        document.getElementById('donationForm').style.display = 'block';
        document.getElementById('status').textContent = 'Wallet connected!';
      } catch (error) {
        console.error('Connect error:', error);
        document.getElementById('status').textContent = `Error: ${error.message} (Check if on correct chain or try reconnecting)`;
      }
    });

    // Donate button
    document.getElementById('donateButton').addEventListener('click', async () => {
      const amount = document.getElementById('amount').value;
      const name = document.getElementById('name').value || 'Anonymous';
      const message = document.getElementById('message').value;

      if (!amount || !signer) return document.getElementById('status').textContent = 'Connect wallet and enter amount';

      try {
        const priceRes = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=crypto-com-chain&vs_currencies=usd');
        if (!priceRes.ok) throw new Error('Price fetch failed');
        const data = await priceRes.json();
        const croPrice = data['crypto-com-chain'].usd;
        const croAmount = parseFloat(amount) / croPrice;
        const croWei = ethers.parseEther(croAmount.toFixed(6).toString());

        const tx = await signer.sendTransaction({ to: creatorAddress, value: croWei });
        await tx.wait();

        const socket = io();
        socket.emit('donation', {
          amount: parseFloat(amount),
          croAmount: croAmount.toFixed(2),
          name: name,
          message: message,
          txHash: tx.hash
        });

        document.getElementById('status').innerHTML = `Donated! <a href="${networkConfig[selectedNetwork].explorerUrl}/tx/${tx.hash}" target="_blank">Tx: ${tx.hash}</a> from ${name}: ${message}`;
      } catch (error) {
        console.error('Donation error:', error);
        document.getElementById('status').textContent = `Error: ${error.message} (Check funds, gas, or network)`;
      }
    });

    // Dark mode toggle function
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
    }
  </script>
</body>
</html>